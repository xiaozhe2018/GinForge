# ğŸŒ GinForge WebSocket æ¶æ„è®¾è®¡

## ğŸ—ï¸ æ¶æ„æ¦‚è¿°

GinForge é‡‡ç”¨**é›†ä¸­å¼ WebSocket Gateway æ¶æ„**ï¼Œå°† WebSocket åŠŸèƒ½é›†æˆåˆ° API Gateway ä¸­ï¼Œå®ç°ç»Ÿä¸€çš„å®æ—¶é€šä¿¡å…¥å£ã€‚

### è®¾è®¡åŸåˆ™

1. **èŒè´£å•ä¸€** - Gateway è´Ÿè´£æ‰€æœ‰å®æ—¶é€šä¿¡ï¼ˆHTTP + WebSocketï¼‰
2. **æœåŠ¡è§£è€¦** - é€šè¿‡ Redis PubSub è§£è€¦æœåŠ¡é—´é€šä¿¡
3. **æ°´å¹³æ‰©å±•** - æ”¯æŒå¤šä¸ª Gateway å®ä¾‹è´Ÿè½½å‡è¡¡
4. **ç»Ÿä¸€å…¥å£** - å¯¹å¤–åªæš´éœ²ä¸€ä¸ªç«¯å£ï¼ˆ8080ï¼‰

---

## ğŸ“ æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         å®¢æˆ·ç«¯å±‚                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ Webå‰ç«¯  â”‚  â”‚ Mobile  â”‚  â”‚ Desktop â”‚  â”‚ å…¶ä»–å®¢æˆ·ç«¯â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜       â”‚
â”‚       â”‚            â”‚             â”‚            â”‚             â”‚
â”‚       â”‚ WS://      â”‚ WS://       â”‚ WS://      â”‚ WS://      â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Gateway (8080)                             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚             WebSocket ç®¡ç†å™¨                              â”‚ â”‚
â”‚ â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚ â”‚
â”‚ â”‚  â”‚ è¿æ¥ç®¡ç†    â”‚  â”‚ æˆ¿é—´ç®¡ç†    â”‚  â”‚ æ¶ˆæ¯è·¯ç”±    â”‚     â”‚ â”‚
â”‚ â”‚  â”‚ (Clients)   â”‚  â”‚ (Rooms)     â”‚  â”‚ (Broadcast) â”‚     â”‚ â”‚
â”‚ â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                        â”‚                                      â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚             Redis PubSub è®¢é˜…                             â”‚ â”‚
â”‚ â”‚  è®¢é˜…é¢‘é“:                                                â”‚ â”‚
â”‚ â”‚  - websocket:broadcast       (å¹¿æ’­æ¶ˆæ¯)                  â”‚ â”‚
â”‚ â”‚  - websocket:user:*          (ç”¨æˆ·æ¶ˆæ¯)                  â”‚ â”‚
â”‚ â”‚  - websocket:room:*          (æˆ¿é—´æ¶ˆæ¯)                  â”‚ â”‚
â”‚ â”‚  - websocket:notification:*  (é€šçŸ¥æ¶ˆæ¯)                  â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â†“
               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
               â”‚ Redis PubSub  â”‚ (æ¶ˆæ¯æ€»çº¿)
               â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚              â”‚              â”‚              â”‚
        â†“              â†“              â†“              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  admin-api  â”‚ â”‚  user-api   â”‚ â”‚  file-api   â”‚ â”‚gateway-workerâ”‚
â”‚  (8083)     â”‚ â”‚  (8081)     â”‚ â”‚  (8086)     â”‚ â”‚  (8084)     â”‚
â”‚             â”‚ â”‚             â”‚ â”‚             â”‚ â”‚             â”‚
â”‚ å‘å¸ƒæ¶ˆæ¯:   â”‚ â”‚ å‘å¸ƒæ¶ˆæ¯:   â”‚ â”‚ å‘å¸ƒæ¶ˆæ¯:   â”‚ â”‚ å‘å¸ƒæ¶ˆæ¯:   â”‚
â”‚ - ç”¨æˆ·å˜æ›´  â”‚ â”‚ - è®¢å•çŠ¶æ€  â”‚ â”‚ - ä¸Šä¼ å®Œæˆ  â”‚ â”‚ - å¼‚æ­¥ä»»åŠ¡  â”‚
â”‚ - æƒé™å˜æ›´  â”‚ â”‚ - ç”¨æˆ·é€šçŸ¥  â”‚ â”‚ - å¤„ç†è¿›åº¦  â”‚ â”‚ - å®šæ—¶æé†’  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ æ¶ˆæ¯æµè½¬

### åœºæ™¯ 1: ç”¨æˆ·ç™»å½•åæ¥æ”¶å®æ—¶é€šçŸ¥

```
1. ç”¨æˆ·ç™»å½• admin-api
   â†“
2. å‰ç«¯æºå¸¦ Token è¿æ¥ Gateway WebSocket
   WS://localhost:8080/ws?token=xxx
   â†“
3. Gateway éªŒè¯ Tokenï¼Œå»ºç«‹è¿æ¥
   â†“
4. admin-api åˆ›å»ºç”¨æˆ·æ—¶å‘å¸ƒæ¶ˆæ¯:
   Redis PUBLISH websocket:broadcast {
     "type": "data_update",
     "content": {"entity": "user", "action": "create"}
   }
   â†“
5. Gateway æ¥æ”¶ Redis æ¶ˆæ¯å¹¶å¹¿æ’­
   â†“
6. æ‰€æœ‰è¿æ¥çš„å®¢æˆ·ç«¯å®æ—¶æ”¶åˆ°æ›´æ–°é€šçŸ¥
```

### åœºæ™¯ 2: å‘é€é€šçŸ¥ç»™ç‰¹å®šç”¨æˆ·

```
1. admin-api éœ€è¦é€šçŸ¥ç”¨æˆ· ID=123
   â†“
2. admin-api å‘å¸ƒæ¶ˆæ¯:
   Redis PUBLISH websocket:notification:123 {
     "type": "notification",
     "content": {"title": "ç³»ç»Ÿé€šçŸ¥", "body": "æ‚¨çš„è®¢å•å·²å‘è´§"}
   }
   â†“
3. Gateway æ¥æ”¶æ¶ˆæ¯
   â†“
4. Gateway æŸ¥æ‰¾ç”¨æˆ· 123 çš„æ‰€æœ‰è¿æ¥
   â†“
5. å‘é€ç»™ç”¨æˆ·çš„æ‰€æœ‰å®¢æˆ·ç«¯ï¼ˆæ”¯æŒå¤šç«¯ç™»å½•ï¼‰
```

### åœºæ™¯ 3: æˆ¿é—´å¹¿æ’­

```
1. ç”¨æˆ·åŠ å…¥èŠå¤©å®¤ "chat:room001"
   å®¢æˆ·ç«¯å‘é€: {"type": "join_room", "content": "chat:room001"}
   â†“
2. Gateway å°†ç”¨æˆ·æ·»åŠ åˆ°æˆ¿é—´
   â†“
3. å…¶ä»–æœåŠ¡å‘å¸ƒæˆ¿é—´æ¶ˆæ¯:
   Redis PUBLISH websocket:room:chat:room001 {
     "type": "room_message",
     "content": {"text": "æœ‰æ–°ç”¨æˆ·åŠ å…¥"}
   }
   â†“
4. Gateway å¹¿æ’­ç»™æˆ¿é—´å†…æ‰€æœ‰ç”¨æˆ·
```

---

## ğŸ”‘ æ ¸å¿ƒç»„ä»¶

### 1. WebSocket ç®¡ç†å™¨ (`pkg/websocket/manager.go`)

**èŒè´£**:
- ç®¡ç†æ‰€æœ‰ WebSocket è¿æ¥
- ç»´æŠ¤ç”¨æˆ·ä¸è¿æ¥çš„æ˜ å°„å…³ç³»
- ç®¡ç†æˆ¿é—´å’Œé¢‘é“
- æ¶ˆæ¯è·¯ç”±å’Œå¹¿æ’­

**æ ¸å¿ƒæ–¹æ³•**:
```go
// æ³¨å†Œ/æ³¨é”€å®¢æˆ·ç«¯
Register(client *Client)
Unregister(client *Client)

// æ¶ˆæ¯å‘é€
Broadcast(message *Message)                    // å¹¿æ’­ç»™æ‰€æœ‰äºº
SendToUser(userID string, message *Message)    // å‘é€ç»™ç”¨æˆ·
BroadcastToRoom(room string, message *Message) // å‘é€ç»™æˆ¿é—´
SendNotification(userID string, notification *NotificationMessage) // å‘é€é€šçŸ¥

// çŠ¶æ€æŸ¥è¯¢
IsUserOnline(userID string) bool
GetOnlineUsers() []string
GetStats() map[string]interface{}
```

### 2. Redis PubSub æœåŠ¡ (`services/gateway/internal/service/pubsub_service.go`)

**èŒè´£**:
- è®¢é˜… Redis é¢‘é“
- æ¥æ”¶å…¶ä»–æœåŠ¡å‘å¸ƒçš„æ¶ˆæ¯
- å°†æ¶ˆæ¯è½¬å‘ç»™ WebSocket ç®¡ç†å™¨

**è®¢é˜…é¢‘é“**:
- `websocket:broadcast` - å¹¿æ’­æ¶ˆæ¯
- `websocket:user:*` - ç”¨æˆ·æ¶ˆæ¯ï¼ˆæ”¯æŒé€šé…ç¬¦ï¼‰
- `websocket:room:*` - æˆ¿é—´æ¶ˆæ¯
- `websocket:notification:*` - é€šçŸ¥æ¶ˆæ¯

### 3. é€šçŸ¥å®¢æˆ·ç«¯ (`pkg/notification/client.go`)

**èŒè´£**:
- ä¾›å…¶ä»–æœåŠ¡è°ƒç”¨
- å‘å¸ƒæ¶ˆæ¯åˆ° Redis
- ç®€åŒ– WebSocket æ¶ˆæ¯å‘é€

**ä½¿ç”¨ç¤ºä¾‹**:
```go
// åœ¨ä»»ä½•æœåŠ¡ä¸­ä½¿ç”¨
import "goweb/pkg/notification"

notifyClient := notification.NewClient(redisClient)

// å‘é€é€šçŸ¥ç»™ç”¨æˆ·
notifyClient.SendNotification(ctx, "user123", &websocket.NotificationMessage{
    Title: "è®¢å•é€šçŸ¥",
    Body: "æ‚¨çš„è®¢å•å·²å‘è´§",
    Icon: "Truck",
    Link: "/orders/12345",
})

// å¹¿æ’­é€šçŸ¥
notifyClient.BroadcastNotification(ctx, &websocket.NotificationMessage{
    Title: "ç³»ç»Ÿç»´æŠ¤é€šçŸ¥",
    Body: "ç³»ç»Ÿå°†äºä»Šæ™š22:00è¿›è¡Œç»´æŠ¤",
})
```

---

## ğŸ”§ æœåŠ¡èŒè´£åˆ’åˆ†

### Gateway (8080) - ç»Ÿä¸€é€šä¿¡ç½‘å…³

**HTTP ä»£ç†**:
- âœ… è·¯ç”± HTTP è¯·æ±‚åˆ°å„ä¸ªå¾®æœåŠ¡
- âœ… è´Ÿè½½å‡è¡¡
- âœ… é™æµå’Œç†”æ–­

**WebSocket ç®¡ç†** (NEW):
- âœ… WebSocket è¿æ¥ç®¡ç†
- âœ… å®æ—¶æ¶ˆæ¯è·¯ç”±
- âœ… Redis PubSub è®¢é˜…
- âœ… åœ¨çº¿çŠ¶æ€ç»´æŠ¤

### Gateway Worker (8084) - å¼‚æ­¥ä»»åŠ¡å¤„ç†å™¨

**æ¶ˆæ¯é˜Ÿåˆ—æ¶ˆè´¹**:
- âœ… è®¢å•æé†’
- âœ… ç”¨æˆ·é€šçŸ¥
- âœ… ç³»ç»Ÿæ¸…ç†
- âœ… æ”¯ä»˜é‡è¯•
- âœ… åº“å­˜å‘Šè­¦

**ä¸ WebSocket çš„åä½œ**:
- é€šè¿‡ Redis PubSub å‘é€å®æ—¶é€šçŸ¥
- ä¸ç›´æ¥ç®¡ç† WebSocket è¿æ¥

### å…¶ä»–å¾®æœåŠ¡ (admin-api, user-api, file-api, etc.)

**é€šè¿‡ notification.Client å‘é€ WebSocket æ¶ˆæ¯**:
- âœ… æ•°æ®å˜æ›´é€šçŸ¥
- âœ… æ“ä½œç»“æœé€šçŸ¥
- âœ… è¿›åº¦æ›´æ–°
- âœ… ç³»ç»Ÿæ¶ˆæ¯

---

## ğŸ¯ ä¼˜åŠ¿

### vs ç‹¬ç«‹ WebSocket æœåŠ¡

| ç‰¹æ€§ | ç‹¬ç«‹æœåŠ¡ | é›†æˆåˆ° Gateway |
|------|---------|---------------|
| æœåŠ¡æ•°é‡ | +1 ä¸ªæœåŠ¡ | 0ï¼ˆä½¿ç”¨ç°æœ‰ï¼‰|
| ç«¯å£æ•°é‡ | +1 ä¸ªç«¯å£ | 0ï¼ˆå…±ç”¨8080ï¼‰|
| éƒ¨ç½²å¤æ‚åº¦ | é«˜ | ä½ |
| ç»´æŠ¤æˆæœ¬ | é«˜ | ä½ |
| ç»Ÿä¸€æ€§ | å·®ï¼ˆå¤šä¸ªå…¥å£ï¼‰| å¥½ï¼ˆç»Ÿä¸€å…¥å£ï¼‰|
| èŒè´£æ¸…æ™°åº¦ | ä¸­ | é«˜ |

### æ‰©å±•æ€§

**æ°´å¹³æ‰©å±•**:
```
                     è´Ÿè½½å‡è¡¡
                        â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â†“             â†“             â†“
      Gateway-1     Gateway-2     Gateway-3
      (WebSocket)   (WebSocket)   (WebSocket)
          â”‚             â”‚             â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
                   Redis PubSub
                   (æ¶ˆæ¯åŒæ­¥)
```

- å¤šä¸ª Gateway å®ä¾‹é€šè¿‡ Redis PubSub åŒæ­¥æ¶ˆæ¯
- å®¢æˆ·ç«¯å¯ä»¥è¿æ¥åˆ°ä»»æ„ Gateway
- æ¶ˆæ¯å¯ä»¥åˆ°è¾¾æ‰€æœ‰ Gateway ä¸Šçš„å®¢æˆ·ç«¯

---

## ğŸ“Š æ€§èƒ½è€ƒè™‘

### è¿æ¥æ•°

- å•ä¸ª Gateway: 1ä¸‡+ å¹¶å‘è¿æ¥
- å¤šä¸ª Gateway: çº¿æ€§æ‰©å±•

### æ¶ˆæ¯å»¶è¿Ÿ

- å†…å­˜æ¶ˆæ¯: < 1ms
- Redis PubSub: < 10ms
- ç«¯åˆ°ç«¯: < 50ms

### èµ„æºæ¶ˆè€—

- æ¯ä¸ªè¿æ¥: ~10KB å†…å­˜
- 1ä¸‡è¿æ¥: ~100MB
- CPU: ä¸»è¦åœ¨æ¶ˆæ¯åºåˆ—åŒ–

---

## ğŸ” å®‰å…¨è€ƒè™‘

### è®¤è¯

- âœ… JWT Token è®¤è¯
- âœ… Token è¿‡æœŸè‡ªåŠ¨æ–­å¼€
- âœ… Token é»‘åå•æ”¯æŒ

### æƒé™

- âœ… åŸºäºç”¨æˆ· ID çš„æ¶ˆæ¯éš”ç¦»
- âœ… æˆ¿é—´æƒé™æ§åˆ¶
- âœ… æ¶ˆæ¯æ¥æºéªŒè¯

### é˜²æŠ¤

- âœ… æ¶ˆæ¯å¤§å°é™åˆ¶ï¼ˆ512KBï¼‰
- âœ… è¿æ¥å¿ƒè·³æ£€æµ‹ï¼ˆ60ç§’è¶…æ—¶ï¼‰
- âœ… è‡ªåŠ¨æ–­çº¿é‡è¿
- âœ… æ¶ˆæ¯ç¼“å†²åŒºé™åˆ¶ï¼ˆé˜²æ­¢å†…å­˜æº¢å‡ºï¼‰

---

## ğŸš€ ä½¿ç”¨æŒ‡å—

### åç«¯ï¼šå‘é€ WebSocket æ¶ˆæ¯

```go
// services/admin-api/internal/service/xxx_service.go
import "goweb/pkg/notification"

type SomeService struct {
    notifyClient *notification.Client
}

func (s *SomeService) CreateUser(user *User) error {
    // 1. åˆ›å»ºç”¨æˆ·
    // ...
    
    // 2. å‘é€ WebSocket é€šçŸ¥
    notification := &websocket.NotificationMessage{
        Title: "ç”¨æˆ·åˆ›å»ºæˆåŠŸ",
        Body:  fmt.Sprintf("ç”¨æˆ· %s å·²åˆ›å»º", user.Username),
        Icon:  "UserPlus",
        Link:  "/users/" + user.ID,
    }
    
    // å‘é€ç»™ç‰¹å®šç”¨æˆ·
    s.notifyClient.SendNotification(ctx, adminUserID, notification)
    
    // æˆ–å¹¿æ’­ç»™æ‰€æœ‰åœ¨çº¿ç®¡ç†å‘˜
    s.notifyClient.BroadcastNotification(ctx, notification)
    
    return nil
}
```

### å‰ç«¯ï¼šæ¥æ”¶ WebSocket æ¶ˆæ¯

```typescript
// web/admin/src/utils/websocket.ts
import WebSocketClient from '@/utils/websocket'

// åˆ›å»ºå®¢æˆ·ç«¯
const ws = new WebSocketClient()

// è¿æ¥ï¼ˆæºå¸¦ JWT Tokenï¼‰
ws.connect(token)

// ç›‘å¬é€šçŸ¥
ws.on('notification', (message) => {
  ElNotification({
    title: message.content.title,
    message: message.content.body,
    type: 'info'
  })
})

// ç›‘å¬æ•°æ®æ›´æ–°
ws.on('data_update', (message) => {
  // åˆ·æ–°åˆ—è¡¨
  refreshUserList()
})

// å‘é€æ¶ˆæ¯
ws.send({
  type: 'chat',
  to: 'user123',
  content: { text: 'Hello' }
})
```

---

## ğŸ“ æ¶ˆæ¯åè®®

### æ¶ˆæ¯æ ¼å¼

```typescript
interface WebSocketMessage {
  type: string           // æ¶ˆæ¯ç±»å‹
  id?: string            // æ¶ˆæ¯IDï¼ˆå¯é€‰ï¼‰
  from?: string          // å‘é€è€…ID
  from_name?: string     // å‘é€è€…åç§°
  to?: string            // æ¥æ”¶è€…IDï¼ˆç§èŠï¼‰
  room?: string          // æˆ¿é—´åç§°
  content: any           // æ¶ˆæ¯å†…å®¹
  data?: object          // é¢å¤–æ•°æ®
  timestamp: number      // æ—¶é—´æˆ³
}
```

### æ¶ˆæ¯ç±»å‹

| ç±»å‹ | è¯´æ˜ | æ–¹å‘ |
|------|------|------|
| `welcome` | æ¬¢è¿æ¶ˆæ¯ | æœåŠ¡å™¨ â†’ å®¢æˆ·ç«¯ |
| `ping/pong` | å¿ƒè·³ | åŒå‘ |
| `notification` | é€šçŸ¥æ¶ˆæ¯ | æœåŠ¡å™¨ â†’ å®¢æˆ·ç«¯ |
| `chat` | èŠå¤©æ¶ˆæ¯ | åŒå‘ |
| `broadcast` | å¹¿æ’­æ¶ˆæ¯ | æœåŠ¡å™¨ â†’ å®¢æˆ·ç«¯ |
| `join_room` | åŠ å…¥æˆ¿é—´ | å®¢æˆ·ç«¯ â†’ æœåŠ¡å™¨ |
| `leave_room` | ç¦»å¼€æˆ¿é—´ | å®¢æˆ·ç«¯ â†’ æœåŠ¡å™¨ |
| `room_message` | æˆ¿é—´æ¶ˆæ¯ | åŒå‘ |
| `user_status` | ç”¨æˆ·çŠ¶æ€ | æœåŠ¡å™¨ â†’ å®¢æˆ·ç«¯ |
| `data_update` | æ•°æ®æ›´æ–° | æœåŠ¡å™¨ â†’ å®¢æˆ·ç«¯ |
| `error` | é”™è¯¯æ¶ˆæ¯ | æœåŠ¡å™¨ â†’ å®¢æˆ·ç«¯ |

---

## ğŸ¯ åº”ç”¨åœºæ™¯

### 1. å®æ—¶é€šçŸ¥ç³»ç»Ÿ

**åœºæ™¯**: ç®¡ç†å‘˜åœ¨åå°æ“ä½œï¼Œéœ€è¦å®æ—¶é€šçŸ¥ç›¸å…³ç”¨æˆ·

```go
// admin-api åˆ›å»ºç”¨æˆ·å
notifyClient.BroadcastDataUpdate(ctx, "user", "create", user.ID, userData)

// å‰ç«¯è‡ªåŠ¨åˆ·æ–°ç”¨æˆ·åˆ—è¡¨
ws.on('data_update', (msg) => {
  if (msg.content.entity === 'user' && msg.content.action === 'create') {
    refreshUserList()
  }
})
```

### 2. åœ¨çº¿çŠ¶æ€ç›‘æ§

**åœºæ™¯**: æŸ¥çœ‹å½“å‰åœ¨çº¿çš„ç®¡ç†å‘˜

```vue
<template>
  <el-tag v-for="user in onlineUsers" :key="user">
    {{ user }} åœ¨çº¿
  </el-tag>
</template>

<script setup>
// ç›‘å¬ç”¨æˆ·ä¸Šçº¿/ä¸‹çº¿
ws.on('user_status', (msg) => {
  if (msg.content.status === 'online') {
    onlineUsers.value.push(msg.content.user_id)
  } else {
    const index = onlineUsers.value.indexOf(msg.content.user_id)
    if (index > -1) onlineUsers.value.splice(index, 1)
  }
})
</script>
```

### 3. æ–‡ä»¶ä¸Šä¼ è¿›åº¦

**åœºæ™¯**: å¤§æ–‡ä»¶ä¸Šä¼ æ—¶æ˜¾ç¤ºå®æ—¶è¿›åº¦

```go
// file-api ä¸Šä¼ è¿‡ç¨‹ä¸­
for progress := 0; progress <= 100; progress += 10 {
    notifyClient.SendNotification(ctx, userID, &websocket.NotificationMessage{
        Title: "ä¸Šä¼ è¿›åº¦",
        Body:  fmt.Sprintf("å·²å®Œæˆ %d%%", progress),
    })
    time.Sleep(time.Second)
}
```

### 4. ååŒç¼–è¾‘

**åœºæ™¯**: å¤šäººåŒæ—¶ç¼–è¾‘åŒä¸€ä¸ªæ–‡æ¡£

```typescript
// ç”¨æˆ·åŠ å…¥ç¼–è¾‘æˆ¿é—´
ws.joinRoom('doc:12345')

// ç›‘å¬æˆ¿é—´æ¶ˆæ¯
ws.on('room_message', (msg) => {
  if (msg.room === 'doc:12345') {
    // åº”ç”¨å…¶ä»–ç”¨æˆ·çš„ç¼–è¾‘
    applyChanges(msg.content.changes)
  }
})

// å‘é€ç¼–è¾‘å†…å®¹
ws.sendToRoom('doc:12345', {
  type: 'edit',
  changes: [...edits]
})
```

---

## âš¡ æœ€ä½³å®è·µ

### 1. æ¶ˆæ¯å»é‡

```go
// ä½¿ç”¨æ¶ˆæ¯ ID é˜²æ­¢é‡å¤å¤„ç†
message.SetData("message_id", uuid.New().String())
```

### 2. æ¶ˆæ¯æŒä¹…åŒ–

```go
// ç¦»çº¿æ¶ˆæ¯å­˜å‚¨åˆ°æ•°æ®åº“
if !wsManager.IsUserOnline(userID) {
    saveOfflineMessage(userID, message)
}
```

### 3. é”™è¯¯å¤„ç†

```typescript
ws.onError((error) => {
  ElMessage.error('è¿æ¥å¼‚å¸¸ï¼Œæ­£åœ¨é‡è¿...')
})

ws.onClose(() => {
  // è‡ªåŠ¨é‡è¿ï¼ˆå†…ç½®ï¼‰
})
```

### 4. æ€§èƒ½ä¼˜åŒ–

```go
// æ‰¹é‡å‘é€
messages := []*websocket.Message{msg1, msg2, msg3}
for _, msg := range messages {
    wsManager.Broadcast(msg)
}
```

---

## ğŸ“ˆ ç›‘æ§æŒ‡æ ‡

### WebSocket æŒ‡æ ‡

```bash
# è·å–ç»Ÿè®¡ä¿¡æ¯
curl http://localhost:8080/ws/stats

# å“åº”
{
  "total_clients": 123,   # æ€»è¿æ¥æ•°
  "online_users": 89,     # åœ¨çº¿ç”¨æˆ·æ•°
  "total_rooms": 5,       # æˆ¿é—´æ•°
  "uptime": 3600          # è¿è¡Œæ—¶é—´ï¼ˆç§’ï¼‰
}
```

### Prometheus æŒ‡æ ‡

- `websocket_connections_total` - æ€»è¿æ¥æ•°
- `websocket_messages_sent_total` - å‘é€æ¶ˆæ¯æ•°
- `websocket_messages_received_total` - æ¥æ”¶æ¶ˆæ¯æ•°
- `websocket_errors_total` - é”™è¯¯æ•°

---

## ğŸ”„ éƒ¨ç½²ç­–ç•¥

### å•å®ä¾‹éƒ¨ç½²

```yaml
# docker-compose.yml
gateway:
  ports:
    - "8080:8080"
  environment:
    - REDIS_ENABLED=true
```

### å¤šå®ä¾‹éƒ¨ç½²ï¼ˆé«˜å¯ç”¨ï¼‰

```yaml
gateway:
  deploy:
    replicas: 3          # 3ä¸ªå®ä¾‹
  ports:
    - "8080-8082:8080"   # æ˜ å°„å¤šä¸ªç«¯å£
  
nginx:
  # Nginx è´Ÿè½½å‡è¡¡
  upstream gateway_backend {
    server gateway1:8080
    server gateway2:8080
    server gateway3:8080
  }
```

**æ³¨æ„**: å¤šå®ä¾‹éƒ¨ç½²æ—¶ï¼Œå¿…é¡»å¯ç”¨ Redisï¼Œå¦åˆ™æ¶ˆæ¯æ— æ³•åœ¨å®ä¾‹é—´åŒæ­¥ã€‚

---

## ğŸ†š å¯¹æ¯”å…¶ä»–æ–¹æ¡ˆ

### æ–¹æ¡ˆå¯¹æ¯”

| ç‰¹æ€§ | ç‹¬ç«‹ WebSocket æœåŠ¡ | é›†æˆåˆ° Gateway | é›†æˆåˆ°ä¸šåŠ¡æœåŠ¡ |
|------|-------------------|---------------|---------------|
| æœåŠ¡æ•°é‡ | +1 | 0 | 0 |
| èŒè´£æ¸…æ™° | â­â­â­ | â­â­â­â­â­ | â­â­ |
| éƒ¨ç½²å¤æ‚åº¦ | é«˜ | ä½ | ä¸­ |
| æ‰©å±•æ€§ | â­â­â­â­ | â­â­â­â­â­ | â­â­â­ |
| ç»´æŠ¤æˆæœ¬ | é«˜ | ä½ | ä¸­ |
| æ¨èåº¦ | â­â­â­ | â­â­â­â­â­ | â­â­ |

**ç»“è®º**: é›†æˆåˆ° Gateway æ˜¯æœ€ä½³æ–¹æ¡ˆï¼

---

## ğŸ“ æ€»ç»“

GinForge çš„ WebSocket æ¶æ„è®¾è®¡ç‰¹ç‚¹ï¼š

1. **ç»Ÿä¸€ç½‘å…³** - HTTP + WebSocket ç»Ÿä¸€å…¥å£
2. **æœåŠ¡è§£è€¦** - é€šè¿‡ Redis PubSub è§£è€¦
3. **èŒè´£æ¸…æ™°** - Gateway ç®¡ç†è¿æ¥ï¼Œå…¶ä»–æœåŠ¡å‘å¸ƒæ¶ˆæ¯
4. **æ˜“äºæ‰©å±•** - æ”¯æŒæ°´å¹³æ‰©å±•å’Œå¤šå®ä¾‹éƒ¨ç½²
5. **å¼€å‘å‹å¥½** - ç®€å•çš„ APIï¼Œæ˜“äºé›†æˆ

**é€‚ç”¨åœºæ™¯**:
- âœ… ä¸­å°å‹åº”ç”¨ï¼ˆ<10ä¸‡å¹¶å‘è¿æ¥ï¼‰
- âœ… éœ€è¦å®æ—¶é€šçŸ¥çš„ç®¡ç†ç³»ç»Ÿ
- âœ… ååŒåŠå…¬åº”ç”¨
- âœ… å®æ—¶ç›‘æ§ç³»ç»Ÿ

**å¤§è§„æ¨¡åœºæ™¯**:
- è€ƒè™‘ä½¿ç”¨ä¸“ä¸šçš„æ¶ˆæ¯æ¨é€æœåŠ¡ï¼ˆå¦‚ Firebase, Pusherï¼‰
- æˆ–ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆKafka + WebSocketï¼‰

---

**æ›´æ–°æ—¶é—´**: 2025-10-14  
**æ¶æ„ç‰ˆæœ¬**: v1.0

